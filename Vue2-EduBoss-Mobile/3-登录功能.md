### â­â­â­â­â­ç™»å½•åŠŸèƒ½

ğŸ• å®ç°æ­¥éª¤ï¼š

> â­ç™»å½•ç»„ä»¶å¸ƒå±€ --> è·¯ç”±ä¿¡æ¯é…ç½® --> ä¸ªäººä¿¡æ¯æ ¡éªŒ --> æ•°æ®çš„è¯·æ±‚ä¸å“åº”â­

```vue
<!--views/login/index.vue-->
<template>
  <div class="login">
    <van-nav-bar></van-nav-bar>
    <van-form></van-form>
  </div>
</template>
```

#### 1ã€é¡¶éƒ¨çŠ¶æ€æ 

ğŸ• å®ç°æ­¥éª¤ï¼š

> ä½¿ç”¨`van-nav-bar`ç»„ä»¶è¿›è¡Œå¸ƒå±€è®¾ç½®ï¼Œ`left-arrow`è®¾ç½®è¿”å›é”®ï¼Œè‡ªå®šä¹‰`onClickLeft`äº‹ä»¶

```vue
<!--views/login/index.vue-->
<template>
  <div class="login">
    <van-nav-bar title="ç™»å½•" left-text="è¿”å›" left-arrow @click-left="onClickLeft"/>
  </div>
</template>
<script>
  export default {
    name: 'Login',
    methods: {
      //ç‚¹å‡»è¿”å›ä¸Šä¸€æ­¥çš„äº‹ä»¶å‡½æ•°é€»è¾‘
      onClickLeft () {
        this.$router.go(-1)
      }
    }
  }
</script>
```

#### 2ã€ç™»å½•ä¸»ä½“å†…å®¹

â­ç†æ¸…æ¥šç™»å½•è¿‡ç¨‹ä¸­çš„å…³ç³»åˆ¤æ–­å’Œæ“ä½œè¿‡ç¨‹â­

ğŸ• å®ç°æ­¥éª¤ï¼š

> ç™»å½•çš„è¡¨å•å¸ƒå±€å’Œè¡¨å•æ•°æ®æ ¡éªŒ
>
> ä½¿ç”¨`van-form`ç»„ä»¶è¿›è¡ŒåŸºç¡€å¸ƒå±€ï¼Œ`van-field`ä¸ºå…¶å­é€‰é¡¹ï¼Œè‡ªå®šä¹‰`onSubmit`äº‹ä»¶
>
> é€šè¿‡`rules`è¿›è¡Œæ ¡éªŒè§„åˆ™çš„å®šä¹‰ï¼Œä½¿ç”¨`validator`æ ¡éªŒéœ€è¦è®¾ç½®æ ¡éªŒå‡½æ•°ï¼Œä½¿ç”¨`pattern`ç›´æ¥å†™æ­£åˆ™æ ¡éªŒ
>
> `button`ç»„ä»¶è®¾ç½®`loading`æ¥é¿å…é¢‘ç¹ç‚¹å‡»é€ æˆçš„é‡å¤è¯·æ±‚
>
> ç™»é™†çŠ¶æ€å­˜å‚¨å†storeä¸­ï¼Œå¹¶è®¾ç½®å¯¼èˆªå®ˆå«ï¼Œæœ€åå¤„ç†æ¥å£é‰´æƒå¤„ç†ã€Tokenä¿¡æ¯å¤„ç†
>
> åœ¨æ¥å£è°ƒç”¨æ—¶è¿›è¡Œæ¥å£é‰´æƒå¤„ç†ï¼Œåœ¨headerä¸­è®¾ç½®access_tokenï¼Œå°†å…¶å‘é€ç»™æ¥å£è¿›è¡Œåˆ¤æ–­å¤„ç†ï¼Œä½¿ç”¨è¯·iå»æ‹¦æˆªå™¨åš

```vue
<!--views/login/index.vue-->
<template>
  <div class="login">
    <van-form @submit="onSubmit">
  		<van-field v-model="form.phone" name="phone" label="æ‰‹æœºå·" placeholder="æ‰‹æœºå·"
  		  :rules="[
          { required: true, message: 'è¯·å¡«å†™è´¦å·' },
          { validator: phoneCheck, message: 'æ ¼å¼æœ‰è¯¯' }]"/>
  		<van-field v-model="form.password" type="password" name="password" label="å¯†ç "
  		  placeholder="å¯†ç "
  		  :rules="[
          { required: true, message: 'è¯·å¡«å†™å¯†ç ' },
          { pattern: /^[a-zA-Z0-9]{6-12}$/, message: 'æ ¼å¼æœ‰è¯¯' }]"/>
  		<div style="margin: 16px;">
  		  <van-button round block type="info" native-type="submit"
          :loading="isLoading"
        >ç™»å½•</van-button>
  		</div>
		</van-form>
  </div>
</template>
<script>
  //å¼•å…¥è¯·æ±‚æ¨¡å—
  import { login } from '@/services/user.js'
  export default {
    name: 'Login',
    data () {
      return {
        form: { phone: '', password: '' },//æ¥æ”¶ç™»å½•çš„ä¿¡æ¯æ•°æ®(è´¦å·å’Œå¯†ç )
        isLoading: false//æ§åˆ¶æŒ‰é’®åŠ è½½çŠ¶æ€
      }
    }
    methods: {
    	//ç‚¹å‡»æäº¤ï¼Œå‘é€è¯·æ±‚ï¼Œä½¿ç”¨å¼‚æ­¥å½¢å¼æ“ä½œ
      async onSubmit () {
        //å¤„äºåŠ è½½çŠ¶æ€
        this.isLoading = true
        const { data } = await login(this.form)
        //åšç™»å½•åˆ¤æ–­æ“ä½œ
        if (data.state === 1) {
          this.$toast.success('Success!')
          //å°†æˆåŠŸçš„ç™»å½•ä¿¡æ¯å­˜å‚¨åˆ°stateä¸­,æ­¤æ—¶ä¿å­˜çš„ä¿¡æ¯ä¸å…·æœ‰æŒä¹…æ€§ï¼Œåˆ·æ–°å³æ— 
          //éœ€è¦å°†ä¿¡æ¯å­˜å‚¨åˆ°stateçš„æœ¬åœ°å­˜å‚¨ä¸­
          this.$store.commit('setUser', data.content)
          //ç™»å½•æˆåŠŸåçš„è·³è½¬æ“ä½œ
          this.$router.push(this.$route.query.redirect || '/')
        }
        else { this.$toast.fail('Fail!') }
        //å–æ¶ˆåŠ è½½çŠ¶æ€
        this.isLoading = false
      },
      //æ ¡éªŒæ‰‹æœºå·æ ¼å¼çš„æ ¡éªŒå‡½æ•°ï¼Œä½¿ç”¨æ­£åˆ™å¤„ç†ï¼Œç„¶åå‘ç»™æœåŠ¡ç«¯åšç™»å½•æ ¡éªŒå¤„ç†
      phoneCheck (value) {
        return /^\d{10}$/.test(value)
      }
    }
  }
</script>
<style lang="scss" scoped></style>
```

```js
//services/user.js
import request from '@/utils/request'
export const login = data => {
  return request({
    method: 'POST',
    url: '/front/user/login',
    //è½¬æ¢æˆã€å=å€¼&å=å€¼ã€‘çš„å½¢å¼
    data: new URLSearchParams(data).toString()
  })
}
```

```js
//store/index.js
state: {
  //å­˜å‚¨ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯æ•°æ®
  user: JSON.parse(window.localStroage.getItem('edu-mobile-user') || null)
},
mutations: {
  //ä¿®æ”¹çŠ¶æ€,stateç”¨æ¥å–æ•°æ®ï¼Œpayloadä¼ å…¥çš„æ•°æ®ï¼Œå¾—åˆ°çš„æ•°æ®æ˜¯jsonæ ¼å¼éœ€è¦è½¬æ¢åå­˜å‚¨
  setUser (state, payload) {
    //payloadä¸ºè¯·æ±‚å¾—åˆ°çš„æ•°æ®ï¼Œæ•°æ®ç”±jsonæ ¼å¼è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼è¿›è¡Œå­˜å‚¨
    state.user = JSON.parse(payload)
    //è®¾ç½®æœ¬åœ°å­˜å‚¨
    window.localStroage.setItem('edu-mobile-user', payload)
  }
},
actions: {}
```

```js
//router/index.js
import store from '@/store'
{
  path: '/login',
  name: 'login',
  component: () => import('@/views/login/index.vue'),
  //è·¯ç”±å…ƒä¿¡æ¯ï¼Œç”¨äºç™»å½•å®ˆå«
  meta: { requiresAuth: true }
}
//è®¾ç½®è·¯ç”±çš„å¯¼èˆªå®ˆå«ï¼Œç”¨äºç™»å½•çš„æ£€æµ‹ä¸è·³è½¬ï¼Œåˆ¤æ–­toè·¯ç”±æ˜¯å¦éœ€è¦è®¤è¯
router.beforeEach(to, from, next) => {
  if (to.matched.some(record => record.meta.requiresAuth)) {
    //æœªç™»å½•æ—¶è®¾ç½®çš„è·³è½¬æ“ä½œ
    if (!store.state.user) {
      return next({
        name: 'login',
        query: { redirect: to.fullPath }
      })
    }
    //å·²ç»ç™»å½•æ—¶çš„æ“ä½œ
    next()
  } else { next() }
}
```

```js
//utils/request.js
import store from '@store'
//ä½¿ç”¨è¯·æ±‚æ‹¦æˆªå™¨è¿›è¡Œæ¥å£é‰´æƒå¤„ç†
request.interceptors.request.use(config => {
  const { user } = store.state
  if (user && user.access_token) {
    config.headers.Authorization = user.access_token
  }
  return config
})
//å°è£…å‡½æ•°è·³è½¬åˆ°ç™»å½•é¡µ
function redirectLogin () {
  router.push({
    name: 'login',
    query: {
      redirect: router.currentRoute.fullPath
    }
  })
}
//æ ‡è®°tokenåˆ·æ–°çŠ¶æ€ï¼Œé¿å…é‡å¤æ“ä½œ
let isRefreshing = false
//å­˜å‚¨åˆ·æ–°æ—¶ç­‰å¾…çš„è¯·æ±‚
let requsets = []
//ä½¿ç”¨å“åº”æ‹¦æˆªå™¨è¿›è¡ŒTokenåˆ·æ–°å¤„ç†
request.interceptors.response.use(response => {
  return response
}, async error => {
  //å­˜åœ¨å“åº”å†…å®¹ä½†æ˜¯å‡ºé”™äº†
  if (error.response) {
    //æ£€æµ‹çŠ¶æ€ç æ˜¯å¦ä¸º401
    if (error.response.status === 401) {
      //æ£€æµ‹æ˜¯å¦å­˜åœ¨ç™»å½•ä¿¡æ¯
      if (!store.state.user) {
        redirectLogin()
        return Promise.reject(error)//ä¸å­˜åœ¨ç»“æŸå³å¯
      }
      //å‘é€è¯·æ±‚å‰æ£€æµ‹æ˜¯å¦å­˜åœ¨æ­£åœ¨åˆ·æ–°çš„tokenè¯·æ±‚
      if (isRefreshing) {
        return requsets.push(() => {
          request(error.config)//å¤±è´¥è¯·æ±‚çš„é…ç½®å¯¹è±¡
        })
      }
      //æ›´æ”¹åˆ·æ–°tokençŠ¶æ€ï¼Œå…è®¸åç»­æ“ä½œè¿›è¡Œåˆ·æ–°tokenå¤„ç†
      isRefreshing = true
      //å­˜åœ¨ç™»å½•ä¿¡æ¯ï¼Œé€šè¿‡refresh_tokenå‘é€ç»™æ¥å£ï¼Œå¾—åˆ°æ–°çš„access_tokenä½¿ç”¨
      const { data } = await request({
        method: 'POST',
        url: '/front/user/refresh_token',
        data: new window.URLSearchParams({
          refreshtoken: store.state.user.refresh_token
        }).toString
      })
      if (data.state !== 1) {
        //åˆ·æ–°tokenå¤±è´¥
        store.commit('setUser', null)
        redirectLogin()
        return Promise.reject(error)
      }
      //åˆ·æ–°tokenæˆåŠŸ
      store.commit('setUser', data.content)
      //é‡æ–°å‘é€requsetsä¸­çš„æ‰€æœ‰è¯·æ±‚
      requets.forEach(callback => callback())
      requests = []
      isRefreshing = false//æ”¹å˜åˆ·æ–°çŠ¶æ€ä¸ºåœæ­¢
      return request(error.config)
    }
  }
  return Promise.reject(error)
})
```

